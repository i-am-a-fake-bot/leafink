<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <title>Leafink eBook Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f4f4; }
        #viewer { flex-grow: 1; width: 100%; background: white; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border-bottom: 1px solid #ddd; }
        .controls { padding: 15px; background: #fff; border-top: 1px solid #ddd; text-align: center; }
        select { padding: 5px; max-width: 200px; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        
        /* Library Styles */
        #library { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 20px; flex-grow: 1; overflow-y: auto; transition: opacity 0.4s ease-in-out; }
        .book-item { background: #fff; border: 1px solid #ddd; padding: 15px; text-align: center; cursor: pointer; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .book-item:hover { background: #f0f0f0; transform: translateY(-2px); transition: 0.2s; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div>
            <button id="backBtn" onclick="showLibrary()">üè† Library</button>
            <input type="file" id="input" accept=".epub">
        </div>
        <select id="toc" class="hidden"><option>Contents</option></select>
        <button id="installBtn" style="display:none;">üì• Install</button>
    </div>

    <div id="library"></div>
    
    <div id="viewer" class="hidden"></div>

    <div class="controls hidden">
        <button id="prev">‚Üê Prev</button>
        <button id="next">Next ‚Üí</button>
    </div>

<script>
    let book, rendition;
    const input = document.getElementById("input");
    const tocSelect = document.getElementById("toc");
    const installBtn = document.getElementById('installBtn');
    const libraryDiv = document.getElementById("library");
    const viewerDiv = document.getElementById("viewer");
    const controlsDiv = document.querySelector(".controls");
    const backBtn = document.getElementById("backBtn");
    let deferredPrompt; 

    // Open/Create Database
    const dbRequest = indexedDB.open("ReaderDB", 1);
    dbRequest.onupgradeneeded = e => {
        let db = e.target.result;
        if (!db.objectStoreNames.contains("books")) {
            db.createObjectStore("books", { keyPath: "name" });
        }
    };

    function showLibrary() {
        if (book) book.destroy();
        libraryDiv.classList.remove("hidden");
        viewerDiv.classList.add("hidden");
        controlsDiv.classList.add("hidden");
        tocSelect.classList.add("hidden");
        backBtn.classList.remove("hidden");
        updateLibraryUI();
    }

    async function loadBook(data) {
        // UI Switching
        libraryDiv.classList.add("hidden");
        viewerDiv.classList.remove("hidden");
        controlsDiv.classList.remove("hidden");
        tocSelect.classList.remove("hidden");
        backBtn.classList.remove("hidden");

        if (book) book.destroy();
        book = ePub(data);
        
        rendition = book.renderTo("viewer", { 
            width: "100%", 
            height: "100%", 
            flow: "paginated",
            manager: "default"
        });

        rendition.hooks.content.register((contents) => {
            contents.addStylesheetRules({
                "body": { "transition": "transform 0.5s ease-in-out !important" }
            });
        });

        let touchStartX = 0;
        rendition.on("touchstart", event => { touchStartX = event.changedTouches[0].screenX; });
        rendition.on("touchend", event => {
            const touchEndX = event.changedTouches[0].screenX;
            if (touchEndX < touchStartX - 50) rendition.next();
            if (touchEndX > touchStartX + 50) rendition.prev();
        });
        
        book.loaded.navigation.then(nav => {
            tocSelect.innerHTML = '<option>Contents</option>';
            nav.toc.forEach(chapter => {
                const option = document.createElement("option");
                option.textContent = chapter.label;
                option.value = chapter.href;
                tocSelect.appendChild(option);
            });
        });

        rendition.on("relocated", location => {
            localStorage.setItem("lastLocation", location.start.cfi);
        });

        const savedLocation = localStorage.getItem("lastLocation");
        rendition.display(savedLocation || undefined);
    }

    function updateLibraryUI() {
        const request = indexedDB.open("ReaderDB", 1);
        request.onsuccess = e => {
            const db = e.target.result;
            const transaction = db.transaction("books", "readonly");
            const store = transaction.objectStore("books");
            const getAll = store.getAll();

            getAll.onsuccess = () => {
                libraryDiv.innerHTML = "";
                if (getAll.result.length === 0) {
                    libraryDiv.innerHTML = "<p style='grid-column: 1/-1; text-align:center; color:#888;'>No books saved. Click 'Choose File' to add one!</p>";
                }
                getAll.result.forEach(item => {
                    const card = document.createElement("div");
                    card.className = "book-item";
                    card.innerHTML = `
                        <div style="text-align:right; margin-bottom:-10px;">
                            <button onclick="deleteBook('${item.name.replace(/'/g, "\\'")}', event)" 
                                style="background:none; color:#ff4d4d; padding:0; font-weight:bold;">‚ùå</button>
                        </div>
                        <span style="font-size:30px">üìñ</span>
                        <br><small style="display:block; margin-top:5px; word-break:break-all;">${item.name}</small>`;
                    card.onclick = () => {
                        localStorage.setItem("lastBookName", item.name);
                        loadBook(item.data);
                    };
                    libraryDiv.appendChild(card);
                });
            };
        };
    }

    tocSelect.onchange = () => rendition.display(tocSelect.value);
    document.getElementById("next").onclick = () => rendition?.next();
    document.getElementById("prev").onclick = () => rendition?.prev();

    input.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        
        const request = indexedDB.open("ReaderDB", 1);
        request.onsuccess = ev => {
            const db = ev.target.result;
            db.transaction("books", "readwrite").objectStore("books").put({
                name: file.name,
                data: arrayBuffer
            });
            updateLibraryUI();
            localStorage.setItem("lastBookName", file.name);
            loadBook(arrayBuffer);
        };
    });

    window.onload = () => {
        updateLibraryUI();
        const lastBookName = localStorage.getItem("lastBookName");
        
        if (lastBookName) {
            const request = indexedDB.open("ReaderDB", 1);
            request.onsuccess = e => {
                const db = e.target.result;
                db.transaction("books").objectStore("books").get(lastBookName).onsuccess = event => {
                    //if (event.target.result) loadBook(event.target.result.data);
                };
            };
        }
    };

    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'inline-block';
    });
    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') installBtn.style.display = 'none';
            deferredPrompt = null;
        }
    });

    function deleteBook(name, event) {
        event.stopPropagation(); // Prevents the book from opening when you click delete
        if (!confirm(`Delete "${name}"?`)) return;
    
        const request = indexedDB.open("ReaderDB", 1);
        request.onsuccess = e => {
            const db = e.target.result;
            const transaction = db.transaction("books", "readwrite");
            transaction.objectStore("books").delete(name);
            transaction.oncomplete = () => {
                if (localStorage.getItem("lastBookName") === name) {
                    localStorage.removeItem("lastBookName");
                }
                updateLibraryUI();
            };
        };
    }
    
</script>
</body>
</html>



