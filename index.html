<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <title>LiteRead PWA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        #viewer { width: 100vw; height: 80vh; margin: 0 auto; }
        .controls { text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <input type="file" id="input" accept=".epub">
    <div id="viewer"></div>
    <div class="controls">
        <button id="prev">← Prev</button>
        <button id="next">Next →</button>
    </div>

<script>
    let book, rendition;
    const input = document.getElementById("input");

    // 1. Function to display the book
    async function loadBook(data) {
        if (book) book.destroy(); // Clear old book if it exists
        
        book = ePub(data);
        rendition = book.renderTo("viewer", { 
            width: "100%", height: "100%", flow: "paginated" 
        });

        rendition.on("relocated", (location) => {
            localStorage.setItem("lastLocation", location.start.cfi);
        });

        const savedLocation = localStorage.getItem("lastLocation");
        rendition.display(savedLocation || undefined);
    }

    // 2. Handle new file uploads
    input.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        const arrayBuffer = await file.arrayBuffer();
        
        // Save to IndexedDB (simplified example using a basic store)
        saveToDb(arrayBuffer); 
        loadBook(arrayBuffer);
    });

    // 3. Simple IndexedDB logic to auto-load on refresh
    function saveToDb(data) {
        const request = indexedDB.open("ReaderDB", 1);
        request.onupgradeneeded = e => e.target.result.createObjectStore("books");
        request.onsuccess = e => {
            const db = e.target.result;
            db.transaction("books", "readwrite").objectStore("books").put(data, "lastBook");
        };
    }

    window.onload = () => {
        const request = indexedDB.open("ReaderDB", 1);
        request.onsuccess = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("books")) return;
            db.transaction("books").objectStore("books").get("lastBook").onsuccess = event => {
                if (event.target.result) loadBook(event.target.result);
            };
        };
    };

    document.getElementById("next").onclick = () => rendition?.next();
    document.getElementById("prev").onclick = () => rendition?.prev();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>