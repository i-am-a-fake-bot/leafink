<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leafink Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        /* Force the nav-bar to always stay on top of the book */
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f4f4; }
        
        .nav-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            background: #fff; 
            border-bottom: 2px solid #007bff; 
            z-index: 9999; /* This keeps the buttons above the book content */
            position: relative;
        }

        #viewer { flex-grow: 1; width: 100%; background: white; height: 100%; }
        
        #library { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 15px; 
            padding: 20px; 
            background: #f4f4f4;
        }

        .book-item { background: #fff; border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; }
        
        .hidden { display: none !important; }

        button { padding: 10px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        #backBtn { background: #28a745; } /* Different color to make it stand out */
    </style>
</head>
<body>

    <div class="nav-bar">
        <div>
            <button id="backBtn" onclick="showLibrary()">üè† Home / Library</button>
            <input type="file" id="input" accept=".epub">
        </div>
        <select id="toc" class="hidden"></select>
    </div>

    <div id="library"></div>
    
    <div id="viewer" class="hidden"></div>

    <div id="controls" class="controls hidden" style="text-align:center; padding: 10px; background: white; border-top: 1px solid #ddd;">
        <button id="prev">‚Üê Prev</button>
        <button id="next">Next ‚Üí</button>
    </div>

<script>
let book, rendition;
    const libraryDiv = document.getElementById("library");
    const viewerDiv = document.getElementById("viewer");
    const controlsDiv = document.getElementById("controls");
    const tocSelect = document.getElementById("toc");
    const input = document.getElementById("input");
    const backBtn = document.getElementById("backBtn");

    // 1. DATABASE SETUP
    const dbRequest = indexedDB.open("ReaderDB", 1);
    dbRequest.onupgradeneeded = e => {
        e.target.result.createObjectStore("books", { keyPath: "name" });
    };

    // 2. SHOW LIBRARY (HOME VIEW)
    function showLibrary() {
        // Clean up memory
        if (book) { book.destroy(); book = null; }
        
        // UI Toggle
        libraryDiv.classList.remove("hidden");
        input.classList.remove("hidden");
        
        viewerDiv.classList.add("hidden");
        controlsDiv.classList.add("hidden");
        tocSelect.classList.add("hidden");
        backBtn.classList.add("hidden"); // Hide home button when already home
        
        updateLibraryUI();
    }

    // 3. LOAD BOOK (READ VIEW)
    async function loadBook(data) {
        // Show Reader UI first
        libraryDiv.classList.add("hidden");
        input.classList.add("hidden");
        
        viewerDiv.classList.remove("hidden");
        controlsDiv.classList.remove("hidden");
        tocSelect.classList.remove("hidden");
        backBtn.classList.remove("hidden"); // Show home button to allow escape

        if (book) book.destroy();
        
        book = ePub(data);
        rendition = book.renderTo("viewer", { 
            width: "100%", 
            height: "100%", 
            flow: "paginated",
            manager: "default"
        });

        // CRITICAL: Wait for the div to exist in the DOM before displaying
        setTimeout(() => {
            rendition.display();
        }, 100);

        book.loaded.navigation.then(nav => {
            tocSelect.innerHTML = '<option value="">Contents</option>';
            nav.toc.forEach(chap => {
                const opt = document.createElement("option");
                opt.textContent = chap.label;
                opt.value = chap.href;
                tocSelect.appendChild(opt);
            });
        });
    }

    // 4. DRAW THE LIBRARY GRID
    function updateLibraryUI() {
        const req = indexedDB.open("ReaderDB", 1);
        req.onsuccess = e => {
            const db = e.target.result;
            const tx = db.transaction("books", "readonly");
            const store = tx.objectStore("books");
            const getAll = store.getAll();

            getAll.onsuccess = () => {
                libraryDiv.innerHTML = "";
                if (getAll.result.length === 0) {
                    libraryDiv.innerHTML = "<p style='grid-column:1/-1; text-align:center; padding:40px; color:#888;'>No books saved. Upload one!</p>";
                }
                getAll.result.forEach(item => {
                    const card = document.createElement("div");
                    card.className = "book-item";
                    // Fixed the string escaping for book names
                    const safeName = item.name.replace(/'/g, "\\'");
                    card.innerHTML = `
                        <div style="text-align:right">
                            <button onclick="deleteBook('${safeName}', event)" style="background:none; color:red; padding:0;">‚úï</button>
                        </div>
                        <strong>üìñ</strong><br><small>${item.name}</small>`;
                    card.onclick = () => loadBook(item.data);
                    libraryDiv.appendChild(card);
                });
            };
        };
    }

    function deleteBook(name, event) {
        event.stopPropagation();
        if (!confirm("Delete?")) return;
        const req = indexedDB.open("ReaderDB", 1);
        req.onsuccess = e => {
            e.target.result.transaction("books", "readwrite").objectStore("books").delete(name).onsuccess = () => updateLibraryUI();
        };
    }

    // 5. FILE UPLOAD
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const data = await file.arrayBuffer();
        const req = indexedDB.open("ReaderDB", 1);
        req.onsuccess = ev => {
            const db = ev.target.result;
            const tx = db.transaction("books", "readwrite");
            tx.objectStore("books").put({ name: file.name, data: data });
            tx.oncomplete = () => loadBook(data);
        };
    };

    tocSelect.onchange = () => rendition.display(tocSelect.value);
    document.getElementById("next").onclick = () => rendition?.next();
    document.getElementById("prev").onclick = () => rendition?.prev();

    window.onload = showLibrary;

</script>
</body>
</html>
