<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leafink eBook Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f4f4; }
        #viewer { flex-grow: 1; width: 100%; background: white; height: 100%; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border-bottom: 1px solid #ddd; z-index: 10; }
        .controls { padding: 15px; background: #fff; border-top: 1px solid #ddd; text-align: center; }
        .hidden { display: none !important; }
        
        /* Library Styles */
        #library { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; flex-grow: 1; overflow-y: auto; }
        .book-item { background: #fff; border: 1px solid #ddd; padding: 15px; text-align: center; cursor: pointer; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div>
            <button id="backBtn" class="hidden" onclick="showLibrary()">üè† Library</button>
            <input type="file" id="input" accept=".epub">
        </div>
        <select id="toc" class="hidden"><option>Contents</option></select>
    </div>

    <div id="library"></div>
    
    <div id="viewer" class="hidden"></div>

    <div class="controls hidden">
        <button id="prev">‚Üê Prev</button>
        <button id="next">Next ‚Üí</button>
    </div>

<script>
    let book, rendition;
    const input = document.getElementById("input");
    const tocSelect = document.getElementById("toc");
    const libraryDiv = document.getElementById("library");
    const viewerDiv = document.getElementById("viewer");
    const controlsDiv = document.querySelector(".controls");
    const backBtn = document.getElementById("backBtn");

    // Initialize Database
    const dbRequest = indexedDB.open("ReaderDB", 1);
    dbRequest.onupgradeneeded = e => {
        let db = e.target.result;
        if (!db.objectStoreNames.contains("books")) {
            db.createObjectStore("books", { keyPath: "name" });
        }
    };

    function showLibrary() {
        if (book) { book.destroy(); book = null; }
        
        // Ensure Reader elements are hidden
        viewerDiv.classList.add("hidden");
        controlsDiv.classList.add("hidden");
        tocSelect.classList.add("hidden");
        backBtn.classList.add("hidden");
        
        // Ensure Library elements are shown
        libraryDiv.classList.remove("hidden");
        input.classList.remove("hidden");
        
        updateLibraryUI();
    }

    async function loadBook(data) {
        // Switch UI
        libraryDiv.classList.add("hidden");
        input.classList.add("hidden");
        
        viewerDiv.classList.remove("hidden");
        controlsDiv.classList.remove("hidden");
        tocSelect.classList.remove("hidden");
        backBtn.classList.remove("hidden");

        if (book) book.destroy();
        book = ePub(data);
        rendition = book.renderTo("viewer", { width: "100%", height: "100%", flow: "paginated" });
        rendition.display();

        book.loaded.navigation.then(nav => {
            tocSelect.innerHTML = '<option>Contents</option>';
            nav.toc.forEach(chapter => {
                const option = document.createElement("option");
                option.textContent = chapter.label;
                option.value = chapter.href;
                tocSelect.appendChild(option);
            });
        });
    }

    function updateLibraryUI() {
        const request = indexedDB.open("ReaderDB", 1);
        request.onsuccess = e => {
            const db = e.target.result;
            const transaction = db.transaction("books", "readonly");
            const store = transaction.objectStore("books");
            const getAll = store.getAll();

            getAll.onsuccess = () => {
                libraryDiv.innerHTML = "";
                if (getAll.result.length === 0) {
                    libraryDiv.innerHTML = "<p style='grid-column: 1/-1; text-align:center; padding-top:50px; color:#888;'>Your library is empty. Upload an EPUB to start!</p>";
                }
                getAll.result.forEach(item => {
                    const card = document.createElement("div");
                    card.className = "book-item";
                    card.innerHTML = `
                        <div style="text-align:right;">
                            <button onclick="deleteBook('${item.name.replace(/'/g, "\\'")}', event)" style="background:none; color:red; font-size:18px; padding:0;">‚úï</button>
                        </div>
                        <div style="font-size:40px;">üìñ</div>
                        <div style="font-size:12px; margin-top:10px; word-break:break-all;">${item.name}</div>
                    `;
                    card.onclick = () => loadBook(item.data);
                    libraryDiv.appendChild(card);
                });
            };
        };
    }

    function deleteBook(name, event) {
        event.stopPropagation();
        if (!confirm("Delete this book?")) return;
        const request = indexedDB.open("ReaderDB", 1);
        request.onsuccess = e => {
            const db = e.target.result;
            db.transaction("books", "readwrite").objectStore("books").delete(name).onsuccess = () => updateLibraryUI();
        };
    }

    input.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        const request = indexedDB.open("ReaderDB", 1);
        request.onsuccess = ev => {
            const db = ev.target.result;
            db.transaction("books", "readwrite").objectStore("books").put({ name: file.name, data: arrayBuffer }).onsuccess = () => {
                loadBook(arrayBuffer);
            };
        };
    });

    tocSelect.onchange = () => rendition.display(tocSelect.value);
    document.getElementById("next").onclick = () => rendition?.next();
    document.getElementById("prev").onclick = () => rendition?.prev();

    // The logic that forces the library to show on start
    window.onload = () => {
        showLibrary();
    };
</script>
</body>
</html>
