<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <title>Leafink eBook Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f4f4; }
        #viewer { flex-grow: 1; width: 100%; background: white; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border-bottom: 1px solid #ddd; }
        .controls { padding: 15px; background: #fff; border-top: 1px solid #ddd; text-align: center; }
        select { padding: 5px; max-width: 200px; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <input type="file" id="input" accept=".epub">
        <select id="toc"><option>Contents</option></select>
        <button id="installBtn" style="display:none;">üì• Install</button>
    </div>

    <div id="viewer"></div>

    <div class="controls">
        <button id="prev">‚Üê Prev</button>
        <button id="next">Next ‚Üí</button>
    </div>

<script>
    let book, rendition;
    const input = document.getElementById("input");
    const tocSelect = document.getElementById("toc");
    const installBtn = document.getElementById('installBtn');
    let deferredPrompt; 

async function loadBook(data) {
    if (book) book.destroy();
    book = ePub(data);
    
    rendition = book.renderTo("viewer", { 
        width: "100%", 
        height: "100%", 
        flow: "paginated",
        manager: "default"
    });

    // --- SLIDE ANIMATION HOOK ---
    rendition.hooks.content.register((contents) => {
        contents.addStylesheetRules({
            "body": {
                "transition": "transform 0.3s ease-in-out !important",
            }
        });
    });

    // --- Swipe Listeners (Now using local touchStartX to avoid 'this' issues) ---
    let touchStartX = 0;
    rendition.on("touchstart", event => {
        touchStartX = event.changedTouches[0].screenX;
    });

    rendition.on("touchend", event => {
        const touchEndX = event.changedTouches[0].screenX;
        if (touchEndX < touchStartX - 50) rendition.next();
        if (touchEndX > touchStartX + 50) rendition.prev();
    });
    
    book.loaded.navigation.then(nav => {
        tocSelect.innerHTML = '<option>Contents</option>';
        nav.toc.forEach(chapter => {
            const option = document.createElement("option");
            option.textContent = chapter.label;
            option.value = chapter.href;
            tocSelect.appendChild(option);
        });
    });

    rendition.on("relocated", location => {
        localStorage.setItem("lastLocation", location.start.cfi);
    });

    const savedLocation = localStorage.getItem("lastLocation");
    rendition.display(savedLocation || undefined);
}
    // 2. Navigation & Files
    tocSelect.onchange = () => rendition.display(tocSelect.value);
    document.getElementById("next").onclick = () => rendition?.next();
    document.getElementById("prev").onclick = () => rendition?.prev();

    input.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        const arrayBuffer = await file.arrayBuffer();
        saveToDb(arrayBuffer);
        loadBook(arrayBuffer);
    });

    // 3. Database (IndexedDB)
    function saveToDb(data) {
        const request = indexedDB.open("ReaderDB", 1);
        request.onupgradeneeded = e => e.target.result.createObjectStore("books");
        request.onsuccess = e => {
            const db = e.target.result;
            db.transaction("books", "readwrite").objectStore("books").put(data, "lastBook");
        };
    }

    window.onload = () => {
        const request = indexedDB.open("ReaderDB", 1);
        request.onsuccess = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains("books")) return;
            db.transaction("books").objectStore("books").get("lastBook").onsuccess = event => {
                if (event.target.result) loadBook(event.target.result);
            };
        };
    };

    // 4. PWA Registration & Install
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js');
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'inline-block';
    });

    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') installBtn.style.display = 'none';
            deferredPrompt = null;
        }
    });

</script>
</body>
</html>
