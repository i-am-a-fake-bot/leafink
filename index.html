<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leafink Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <style>
        /* Force the nav-bar to always stay on top of the book */
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f4f4; }
        
        .nav-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            background: #fff; 
            border-bottom: 2px solid #007bff; 
            z-index: 9999; /* This keeps the buttons above the book content */
            position: relative;
        }

        #viewer { flex-grow: 1; width: 100%; background: white; height: 100%; }
        
        #library { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 15px; 
            padding: 20px; 
            background: #f4f4f4;
        }

        .book-item { background: #fff; border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; }
        
        .hidden { display: none !important; }

        button { padding: 10px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        #backBtn { background: #28a745; } /* Different color to make it stand out */
    </style>
</head>
<body>

    <div class="nav-bar">
        <div>
            <button id="backBtn" onclick="showLibrary()">üè† Home / Library</button>
            <input type="file" id="input" accept=".epub">
        </div>
        <select id="toc" class="hidden"></select>
    </div>

    <div id="library"></div>
    
    <div id="viewer" class="hidden"></div>

    <div id="controls" class="controls hidden" style="text-align:center; padding: 10px; background: white; border-top: 1px solid #ddd;">
        <button id="prev">‚Üê Prev</button>
        <button id="next">Next ‚Üí</button>
    </div>

<script>
    let book, rendition;
    const libraryDiv = document.getElementById("library");
    const viewerDiv = document.getElementById("viewer");
    const controlsDiv = document.getElementById("controls");
    const tocSelect = document.getElementById("toc");
    const input = document.getElementById("input");
    const backBtn = document.getElementById("backBtn");
    
    // 1. DATABASE SETUP WITH METADATA SUPPORT
    function getDB() {
        return new Promise((resolve, reject) => {
            // Updated to version 2 to handle extra fields
            const request = indexedDB.open("LeafinkDB", 3);
            
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("books")) {
                    db.createObjectStore("books", { keyPath: "name" });
                }
            };

            request.onsuccess = e => resolve(e.target.result);
            request.onerror = e => {
                console.error("DB Error:", e.target.error);
                reject("IndexedDB failed to open");
            };

            request.onblocked = () => {
                console.warn("Database blocked! Please close other tabs.");
            };
        });
    }
    
    // 2. SHOW LIBRARY (HOME VIEW)
    async function showLibrary() {
        if (book) { book.destroy(); book = null; }
        
        libraryDiv.classList.remove("hidden");
        input.classList.remove("hidden");
        viewerDiv.classList.add("hidden");
        controlsDiv.classList.add("hidden");
        tocSelect.classList.add("hidden");
        backBtn.classList.add("hidden");
        
        await updateLibraryUI();
    }
    
    // 3. LOAD BOOK (READ VIEW)
    async function loadBook(data) {
        libraryDiv.classList.add("hidden");
        input.classList.add("hidden");
        viewerDiv.classList.remove("hidden");
        controlsDiv.classList.remove("hidden");
        tocSelect.classList.remove("hidden");
        backBtn.classList.remove("hidden");
    
        if (book) book.destroy();
        
        book = ePub(data);
        rendition = book.renderTo("viewer", { 
            width: "100%", 
            height: "100%", 
            flow: "paginated"
        });
    
        setTimeout(() => {
            rendition.display().catch(err => console.error("Render error:", err));
        }, 200);
    
        book.loaded.navigation.then(nav => {
            tocSelect.innerHTML = '<option value="">Contents</option>';
            nav.toc.forEach(chap => {
                const opt = document.createElement("option");
                opt.textContent = chap.label;
                opt.value = chap.href;
                tocSelect.appendChild(opt);
            });
        });
    }
    
    // 4. DRAW THE LIBRARY GRID (Showing Metadata)
    async function updateLibraryUI() {
        try {
            const db = await getDB();
            const tx = db.transaction("books", "readonly");
            const store = tx.objectStore("books");
            const getAll = store.getAll();
    
            getAll.onsuccess = () => {
                libraryDiv.innerHTML = "";
                const books = getAll.result;
                
                if (books.length === 0) {
                    libraryDiv.innerHTML = "<div style='grid-column:1/-1; text-align:center; padding:40px; color:#666;'>Your library is empty.</div>";
                    return;
                }
    
                books.forEach(item => {
                    const card = document.createElement("div");
                    card.className = "book-item";
                    const safeName = item.name.replace(/'/g, "\\'");
                    
                    // Main layout preserved, added Edit button and metadata text
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="editMeta('${safeName}', event)" style="background:#6c757d; font-size:10px; padding:2px 5px;">Edit</button>
                            <button onclick="deleteBook('${safeName}', event)" style="background:none; color:red; padding:0; font-size:20px;">√ó</button>
                        </div>
                        <div onclick="openBookFromDB('${safeName}')">
                            <div style="font-size:40px;">üìñ</div>
                            <div style="font-size:12px; margin-top:5px; font-weight:bold;">${item.title || item.name}</div>
                            <div style="font-size:10px; color:#666;">${item.author || 'Unknown Author'}</div>
                            <div style="font-size:10px; color:#999; margin-top:2px;">${item.pubdate || 'No Date'}</div>
                            <div style="font-size:10px; color:#777; margin-top:5px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;">
    ${item.summary || 'No summary available.'}</div>
                        </div>`;
                    libraryDiv.appendChild(card);
                });
            };
        } catch (err) {
            libraryDiv.innerHTML = "<p>Error loading library. Please refresh.</p>";
        }
    }

    // Helper: Opens book from Database when card is clicked
    async function openBookFromDB(name) {
        const db = await getDB();
        db.transaction("books").objectStore("books").get(name).onsuccess = e => {
            if (e.target.result) loadBook(e.target.result.data);
        };
    }

    // New: Function to Edit Metadata via prompts
    async function editMeta(name, event) {
        event.stopPropagation();
        const db = await getDB();
        const tx = db.transaction("books", "readwrite");
        const store = tx.objectStore("books");
        
        store.get(name).onsuccess = (e) => {
            const entry = e.target.result;
            const newTitle = prompt("Edit Title:", entry.title || entry.name);
            const newAuthor = prompt("Edit Author:", entry.author || "Unknown Author");
            const newDate = prompt("Edit Date:", entry.pubdate || "No Date");
            const newSum = prompt("Edit Summary:", entry.summary || "No summary available.");
            
            if (newTitle !== null) {
                entry.title = newTitle;
                entry.author = newAuthor;
                entry.pubdate = newDate;
                entry.summary = newSum;
                store.put(entry).onsuccess = () => updateLibraryUI();
            }
        };
    }

    // 5. DELETE & UPLOAD
    async function deleteBook(name, event) {
        event.stopPropagation();
        if (!confirm("Delete this book?")) return;
        const db = await getDB();
        db.transaction("books", "readwrite").objectStore("books").delete(name).onsuccess = () => updateLibraryUI();
    }
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const arrayBuffer = await file.arrayBuffer();
        
        // Extract metadata before saving
        const tempBook = ePub(arrayBuffer);
        const meta = await tempBook.loaded.metadata;

        const db = await getDB();
        const tx = db.transaction("books", "readwrite");
        
        tx.objectStore("books").put({ 
            name: file.name, 
            data: arrayBuffer,
            title: meta.title || file.name,
            author: meta.creator || "Unknown Author",
            pubdate: meta.pubdate || "No Date",
            summary: meta.description || "No summary available."
        });
        
        tx.oncomplete = () => showLibrary();
    };

    // Navigation
    document.getElementById("next").onclick = () => rendition?.next();
    document.getElementById("prev").onclick = () => rendition?.prev();
    tocSelect.onchange = () => rendition.display(tocSelect.value);
    
    // Initial Load
    window.onload = showLibrary;
</script>
</body>
</html>
